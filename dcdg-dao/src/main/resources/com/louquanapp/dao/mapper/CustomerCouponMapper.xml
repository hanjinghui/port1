<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.louquanapp.dao.mapper.CustomerCouponMapper">
  <resultMap id="BaseResultMap" type="com.louquanapp.dao.model.CustomerCoupon">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Tue Jul 09 14:44:52 CST 2019.
    -->
    <id column="CUST_COUPON_ID" jdbcType="CHAR" property="custCouponId" />
    <result column="COUPON_ID" jdbcType="CHAR" property="couponId" />
    <result column="CUST_ID" jdbcType="CHAR" property="custId" />
    <result column="ADD_TIME" jdbcType="TIMESTAMP" property="addTime" />
    <result column="UPDATE_TIME" jdbcType="TIMESTAMP" property="updateTime" />
    <result column="IS_USE" jdbcType="TINYINT" property="isUse" />
    <result column="USER_TIME" jdbcType="TIMESTAMP" property="userTime" />
    <result column="COUPON_IMG" jdbcType="VARCHAR" property="couponImg" />
    <result column="GAIN_ID" jdbcType="CHAR" property="gainId" />
  </resultMap>

  <resultMap id="ExtraBase" type="com.louquanapp.dao.model.CustomerCoupon" extends="BaseResultMap">
    <result column="usedCount"    jdbcType="INTEGER" property="usedCount" />
    <result column="notUsedCount" jdbcType="INTEGER" property="notUsedCount" />
    <result column="expiredCount" jdbcType="INTEGER" property="expiredCount" />

    <result column="couponWay" jdbcType="TINYINT" property="couponWay" />
    <result column="couponName" jdbcType="VARCHAR" property="couponName" />
    <result column="headImg" jdbcType="VARCHAR" property="headImg" />
    <result column="nickName" jdbcType="VARCHAR" property="nickName" />
    <result column="couponConent" jdbcType="VARCHAR" property="couponConent" />
    <result column="couponType" jdbcType="TINYINT" property="couponType" />
    <result column="dieTime" jdbcType="TIMESTAMP" property="dieTime" />
    <result column="couponLogo" jdbcType="VARCHAR" property="couponLogo" />

  </resultMap>
  <delete id="deleteByPrimaryKey" parameterType="java.lang.String">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Tue Jul 09 14:44:52 CST 2019.
    -->
    delete from dcdg_bussiness_customer_coupon
    where CUST_COUPON_ID = #{custCouponId,jdbcType=CHAR}
  </delete>
  <insert id="insert" parameterType="com.louquanapp.dao.model.CustomerCoupon">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Tue Jul 09 14:44:52 CST 2019.
    -->
    insert into dcdg_bussiness_customer_coupon (CUST_COUPON_ID, COUPON_ID, CUST_ID, 
      ADD_TIME, UPDATE_TIME, IS_USE, 
      USER_TIME, COUPON_IMG, GAIN_ID
      )
    values (#{custCouponId,jdbcType=CHAR}, #{couponId,jdbcType=CHAR}, #{custId,jdbcType=CHAR}, 
      #{addTime,jdbcType=TIMESTAMP}, #{updateTime,jdbcType=TIMESTAMP}, #{isUse,jdbcType=TINYINT}, 
      #{userTime,jdbcType=TIMESTAMP}, #{couponImg,jdbcType=VARCHAR}, #{gainId,jdbcType=CHAR}
      )
  </insert>
  <update id="updateByPrimaryKey" parameterType="com.louquanapp.dao.model.CustomerCoupon">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Tue Jul 09 14:44:52 CST 2019.
    -->
    update dcdg_bussiness_customer_coupon
    set COUPON_ID = #{couponId,jdbcType=CHAR},
      CUST_ID = #{custId,jdbcType=CHAR},
      ADD_TIME = #{addTime,jdbcType=TIMESTAMP},
      UPDATE_TIME = #{updateTime,jdbcType=TIMESTAMP},
      IS_USE = #{isUse,jdbcType=TINYINT},
      USER_TIME = #{userTime,jdbcType=TIMESTAMP},
      COUPON_IMG = #{couponImg,jdbcType=VARCHAR},
      GAIN_ID = #{gainId,jdbcType=CHAR}
    where CUST_COUPON_ID = #{custCouponId,jdbcType=CHAR}
  </update>
  <select id="selectByPrimaryKey" parameterType="java.lang.String" resultMap="BaseResultMap">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Tue Jul 09 14:44:52 CST 2019.
    -->
    select CUST_COUPON_ID, COUPON_ID, CUST_ID, ADD_TIME, UPDATE_TIME, IS_USE, USER_TIME, 
    COUPON_IMG, GAIN_ID
    from dcdg_bussiness_customer_coupon
    where CUST_COUPON_ID = #{custCouponId,jdbcType=CHAR}
  </select>
  <select id="selectAll" resultMap="BaseResultMap">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Tue Jul 09 14:44:52 CST 2019.
    -->
    select CUST_COUPON_ID, COUPON_ID, CUST_ID, ADD_TIME, UPDATE_TIME, IS_USE, USER_TIME, 
    COUPON_IMG, GAIN_ID
    from dcdg_bussiness_customer_coupon
  </select>

  <select id="existCustomerCoupon" resultType="Integer">
    select count(CUST_COUPON_ID) from dcdg_bussiness_customer_coupon
      where COUPON_ID = #{couponId,jdbcType=CHAR} and  CUST_ID = #{custId,jdbcType=CHAR}
  </select>
<!--
  <select id="">
     select  count(1) from dcdg_bussiness_customer_coupon  where COUPON_ID = #{couponId,jdbcType=CHAR}
  </select>-->



  <select id="queryCouponCountByCouponId" resultMap="ExtraBase">
    select (
            select count(1) from dcdg_bussiness_customer_coupon  where COUPON_ID = #{couponId,jdbcType=CHAR} and IS_USE = 1
            ) as usedCount
            ,(
            select count(1) from dcdg_bussiness_customer_coupon  where COUPON_ID = #{couponId,jdbcType=CHAR} and IS_USE = 2
            ) as notUsedCount
            ,(
            select count(1) from dcdg_bussiness_customer_coupon  where COUPON_ID = #{couponId,jdbcType=CHAR} and IS_USE = 3
            ) as expiredCount
  </select>


  <select id="writeOffCouponList" resultMap="ExtraBase">
   	select a.CUST_COUPON_ID ,a.CUST_ID,a.USER_TIME,a.COUPON_ID,b.COUPON_WAY as couponWay,b.COUPON_NAME as couponName ,c.HEAD_IMG as headImg,c.NICK_NAME as nickName
      FROM dcdg_bussiness_customer_coupon a  left join   dcdg_basic_coupon_base b on a.COUPON_ID =b.COUPON_ID
          left join dcdg_bussiness_customer_base c on a.CUST_ID=c.CUST_ID
      where      a.GAIN_ID = #{gainId,jdbcType=CHAR}
                   and a.IS_USE = 1
			 and b.COUPON_WAY = 2
  </select>

  <update id="writeOffCoupon">
        update  dcdg_bussiness_customer_coupon set IS_USE=1
         ,GAIN_ID = #{gainId,jdbcType=CHAR}
         , USER_TIME= now()
         where
         IS_USE=2 and  CUST_COUPON_ID = #{custCouponId,jdbcType=CHAR}
    </update>

  <select id="couponDetail" resultMap="ExtraBase">
  select a.CUST_COUPON_ID ,a.CUST_ID,a.USER_TIME,a.COUPON_ID,b.COUPON_NAME as couponName
    ,b.COUPON_CONENT as  couponConent,b.COUPON_TYPE  as  couponType,b.DIE_TIME as dieTime,b.COUPON_LOGO as couponLogo
    FROM dcdg_bussiness_customer_coupon a  left join   dcdg_basic_coupon_base b on a.COUPON_ID =b.COUPON_ID
    where       a.CUST_COUPON_ID =  #{custCouponId,jdbcType=CHAR}
            and a.IS_USE = 2
            and b.COUPON_WAY = 2
            and b.COUPON_TYPE = 2
  </select>


</mapper>